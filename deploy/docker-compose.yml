# SOLVER-Ralph Self-Host Deployment Stack (D-31)
#
# This docker-compose file provides the complete self-host stack for SOLVER-Ralph.
# Per SR-SPEC, this includes all required services for the event-sourced platform.
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose down           # Stop all services
#   docker-compose logs -f        # Follow logs
#   docker-compose ps             # Show service status
#
# Services:
#   - postgres: Event store and projections database
#   - minio: Content-addressed evidence storage
#   - nats: Message bus for orchestration events
#   - zitadel: OIDC identity provider
#   - infisical: Secrets management (optional for dev)
#   - sr-api: SOLVER-Ralph API service

services:
  # PostgreSQL - Event store and projections
  # Version pinned for reproducibility
  postgres:
    image: postgres:16.4-alpine
    container_name: sr-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: solver_ralph
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d solver_ralph"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - sr-network

  # MinIO - S3-compatible object storage for evidence
  minio:
    image: minio/minio:RELEASE.2024-10-02T17-50-41Z
    container_name: sr-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - sr-network

  # NATS - Message bus with JetStream for orchestration
  nats:
    image: nats:2.10.22-alpine
    container_name: sr-nats
    restart: unless-stopped
    command:
      - "--jetstream"
      - "--store_dir=/data"
      - "-m"
      - "8222"
    volumes:
      - nats_data:/data
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # HTTP monitoring
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - sr-network

  # Zitadel - OIDC Identity Provider
  # Note: Zitadel requires initial setup via its console or CLI
  zitadel:
    image: ghcr.io/zitadel/zitadel:v2.64.1
    container_name: sr-zitadel
    restart: unless-stopped
    command: start-from-init --masterkeyFromEnv --tlsMode disabled
    environment:
      ZITADEL_MASTERKEY: "MasterkeyNeedsToHave32Characters"
      ZITADEL_DATABASE_POSTGRES_HOST: postgres
      ZITADEL_DATABASE_POSTGRES_PORT: 5432
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: postgres
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: postgres
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: postgres
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: postgres
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
      ZITADEL_EXTERNALSECURE: "false"
      ZITADEL_EXTERNALDOMAIN: localhost
      ZITADEL_EXTERNALPORT: 8080
      ZITADEL_FIRSTINSTANCE_ORG_NAME: SOLVER-Ralph
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: admin
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: Admin123!
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/debug/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - sr-network

  # MinIO initialization - creates required buckets
  minio-init:
    image: minio/mc:RELEASE.2024-10-02T08-27-28Z
    container_name: sr-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing myminio/evidence;
      mc anonymous set download myminio/evidence;
      echo 'MinIO buckets initialized';
      "
    networks:
      - sr-network

  # SOLVER-Ralph API Service
  # Note: This requires building the Rust service first
  sr-api:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.api
    container_name: sr-api
    restart: unless-stopped
    environment:
      SR_HOST: "0.0.0.0"
      SR_PORT: "3000"
      SR_DATABASE_URL: "postgres://postgres:postgres@postgres:5432/solver_ralph"
      SR_MINIO_ENDPOINT: "http://minio:9000"
      SR_MINIO_ACCESS_KEY: "minioadmin"
      SR_MINIO_SECRET_KEY: "minioadmin"
      SR_MINIO_BUCKET: "evidence"
      SR_NATS_URL: "nats://nats:4222"
      SR_OIDC_ISSUER: "http://zitadel:8080"
      SR_OIDC_AUDIENCE: "355454548799717382,solver-ralph"
      SR_OIDC_JWKS_URI: "http://zitadel:8080/oauth/v2/keys"
      SR_OIDC_SKIP_VALIDATION: "false"
      SR_LOG_LEVEL: "debug"
      RUST_BACKTRACE: "1"
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - sr-network
    profiles:
      - full  # Only start with --profile full

  # SOLVER-Ralph UI
  # Note: This requires building the React UI first
  sr-ui:
    build:
      context: ../ui
      dockerfile: ../deploy/Dockerfile.ui
    container_name: sr-ui
    restart: unless-stopped
    environment:
      VITE_API_URL: "http://localhost:3000"
      VITE_OIDC_ISSUER: "http://localhost:8080"
      VITE_OIDC_CLIENT_ID: "solver-ralph-ui"
    ports:
      - "5173:80"
    depends_on:
      - sr-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - sr-network
    profiles:
      - full  # Only start with --profile full

volumes:
  postgres_data:
    driver: local
  minio_data:
    driver: local
  nats_data:
    driver: local

networks:
  sr-network:
    driver: bridge
