# SR-CODEBASE-AUDIT-PLAN

**Purpose:** Execution plan to remediate consolidated audit findings across trust boundaries, verification, directive alignment, semantic/API gaps, and ontological completeness.

## Phase 1 — Trust Boundary & Verification Enforcement (blocking P1)
- [x] **P1-TB-PORTALS** — Enforce portal whitelist: restrict `portal_id` to seeded portals (`HumanAuthorityExceptionProcess`, `GovernanceChangePortal`, `ReleaseApprovalPortal`) in approval handlers and projections; add tests that non-whitelisted IDs fail and whitelisted pass. (C-TB-4/6)
- [x] **P1-TB-EVIDENCE** — Harden evidence ingestion: require SYSTEM/oracle actors or RunStarted lineage for EvidenceBundleRecorded; reject agent-submitted evidence for verification claims; tests cover agent upload rejection and valid RunStarted-linked upload success. (C-TB-2)
- [x] **P1-VER-COMPUTE** — Implement verification computation: derive required oracle outcomes + waivers → emit `CandidateVerificationComputed`; update projections to store mode/basis; expose verification status with scope (candidate/stage/template); tests assert status transitions for strict pass, waiver-covered fail, uncovered fail, and integrity condition blocking. (C-VER-1..4)
- [x] **P1-SHIP-GATE** — Gate freeze/release on verification + staleness: freeze creation requires Verified (Strict/With-Exceptions), release approval present, and no unresolved staleness; return explicit failure reasons; tests cover freeze rejection when unverified, when stale, and when approval missing, plus success path. (C-SHIP-1, C-EVT-6) *(Freeze handler now blocks on candidate/suite/artifact staleness, enforces release approval acknowledgement of active exceptions, and has unit coverage for unverified/stale/missing-approval/ack paths.)*

## Phase 2 — Directive Alignment: Budgets & Stop Triggers (blocking P1)
- [x] **P1-BUDGET-GOV** — Align governor budget defaults to SR-DIRECTIVE (5 iterations / 25 oracle runs / 16 hours) and parse `budgets` payload (plural); track `max_oracle_runs` exhaustion in stop logic; tests cover: default budgets, honoring requested budgets, max_oracle_runs exhaustion triggering stop, and monotonic budget patching. (C-LOOP-1, SR-DIRECTIVE §4.1) *(Defaults aligned; API/governor honor provided budgets; stop emitted with HumanAuthority routing on `max_oracle_runs` exhaustion; new coverage proves budget extension via `LoopUpdated` clears budget-exhausted stop + portal hold.)*
- [x] **P1-STOPS-COMPLETE** — Complete stop-trigger set: add EVIDENCE_MISSING, ORACLE_FLAKE propagation, REPEATED_FAILURE activation, NO_ELIGIBLE_WORK, STAGE_UNKNOWN, SEMANTIC_PROFILE_MISSING, and max_oracle_runs exhaustion; emit StopTriggered with recommended portal routing; tests assert trigger emission for each condition and pause state change. (SR-DIRECTIVE §4.2, C-OR-7) *(Semantic worker now emits NO_ELIGIBLE_WORK stops; integrity-driven flake/gap/env/tamper/evidence-missing conditions emit IntegrityViolationDetected + StopTriggered to GovernanceChangePortal; governor stops on max_oracle_runs with HumanAuthority recommendation; repeated failure portal alignment covered; stage_unknown/semantic_profile_missing enforced from work-surface start.)*
- [x] **P1-INTEGRITY-WIRE** — Wire integrity checker: invoke IntegrityChecker (incl. flake check) in runner/worker; emit IntegrityViolationDetected/StopTriggered on ORACLE_FLAKE/ENV_MISMATCH/TAMPER/GAP/EVIDENCE_MISSING; tests simulate flake/gap/tamper/env mismatch and verify stop + event emission. (C-OR-5, C-OR-7) *(Semantic worker executes IntegrityChecker post-run, emits violations + GovernanceChangePortal stops for tamper/gap/env/flake/evidence-missing; OracleExecutionWorker path already covered.)*

## Phase 3 — Semantic/API Gaps (blocking P1)
- [x] **P1-STALENESS-API** — Implement staleness APIs: `POST /staleness/mark`, `GET /staleness/dependents`, `POST /staleness/{id}/resolve`; hook graph/projections to set/clear staleness flags that block shippable; tests cover marking, dependent listing, resolving, and shippable recomputation. (SR-SPEC §2.3.11) *(Handlers added with graph-backed staleness markers and shippable staleness flag updates; unit tests cover reason parsing and success paths; full workspace tests passing.)*
- [x] **P1-EVID-STATUS** — Add evidence availability/status endpoint (`GET /evidence/{hash}/status`) returning existence and integrity flags; tests for existing evidence, missing evidence, and integrity violation scenario. (C-EVID-6) *(Status endpoint added with integrity verification; unit coverage for missing/integrity-fail/ok cases; workspace tests passing.)*
- [x] **P1-NOTES-API** — Add human-judgment note APIs: `POST /records/evaluation-notes`, `POST /records/assessment-notes`, retrieval; ensure notes are non-binding and distinguished from approvals; tests for creation, retrieval, and rejection of approval-like decisions. (C-TB-7, SR-SPEC §2.3.10) *(Human-only evaluation/assessment note endpoints added with projection storage; unit coverage enforces non-binding, human-only creation; workspace tests passing.)*

## Phase 4 — Ontological Completeness (P2)
- [x] **P2-TYPES-NOTES** — Add missing record types: EvaluationNote, AssessmentNote, InterventionNote; register type keys, schemas, and serialization. (SR-TYPES §4.4) *(Record types added with serialization + type keys; migration/projection store intervention notes and structured `details`; API exposes intervention note creation + typed responses.)*
- [x] **P2-TYPES-CONFIG** — Add missing config types: AgentDefinition, OracleDefinition, PortalDefinition, SemanticProfile; register type keys and minimal CRUD/registry backing. (SR-TYPES §4.5) *(Config definitions registered via ConfigDefinitionRecorded events, backed by `config_definitions` projection/table, with create/list endpoints for agents, portals, oracle definitions, and semantic profiles.)*
- [x] **P2-TYPES-PROC/LOOPREC** — Add ProcedureInstance representation or explicit mapping to StageStatusRecord; add LoopRecord representation or document Iteration equivalence with projection exposure. (SR-TYPES §4.3/§4.4) *(LoopRecord wraps iteration summary; ProcedureInstance surfaced from work-surface projection; endpoints provide both views by iteration/work surface.)*
- [x] **P2-REFS-VALIDATION** — Validate TypedRef meta: enforce `meta.content_hash` and `meta.type_key` where applicable on ingest; reject incomplete refs; tests ensure invalid refs fail and valid refs pass. (C-META-1..3, C-EVID-4) *(Handlers normalize/validate refs, ensuring content hashes/type keys per StrongTypedRef; validation tests added.)*

## Phase 5 — UI Parity & Tests (P2/P3)
- [x] **P2-TEST-SUITE** — Add automated tests: governor budget/stop-trigger coverage, verification computation + freeze gating, portal whitelist enforcement, integrity flake/evidence-missing triggers, staleness API behavior, note API behavior, evidence status endpoint; prefer integration/E2E where applicable. *(UI parity added with Staleness console + Notes console + seeded-portal UI validation and evidence status surfacing; tests cover portal whitelist validation, staleness resolution kind enforcement, Verified-with-Exceptions freeze gating, evidence-missing integrity stop, note context capture, and evidence status timestamp/integrity flags.)*

## Phase 6 — Governance & Migration (P3)
- [ ] **P3-MIGRATIONS** — Adjust projections/tables for new stop triggers, verification status fields, staleness flags, and new record/config types; include data backfill scripts if needed.
- [ ] **P3-GOV-DOCS** — Update documentation kits (Gate Registry, portal playbooks) to reflect new stop triggers and portal enforcement hooks; record exceptions in SR-EXCEPTIONS if temporary waivers are needed during rollout.

## Risk & Rollback
- **Rollback plan:** For each phase, maintain schema and projection migrations as reversible (down migrations). Keep feature flags/toggles for new enforcement (portal whitelist, evidence actor checks, stop triggers) to allow staged rollout and quick disable if regressions occur.
- **Risk hotspots:** Budget enforcement changes can pause/stop loops unexpectedly; portal whitelisting may block existing approvals with non-seeded IDs; verification gating can block releases if evidence lineage is incomplete. Mitigate with shadow-mode logging before hard enforcement where feasible and add migration scripts to normalize existing data (portal IDs, refs).

## Milestones
- **M1:** Phases 1–3 completed → Trust boundary/verification/directive/staleness gaps closed (blocks P1s).
- **M2:** Phase 4 completed → Ontology/type registry coverage complete.
- **M3:** Phase 5–6 completed → UI parity, tests, migrations, and governed docs updated.
