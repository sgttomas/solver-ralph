---
doc_id: SR-DEPLOYMENT
doc_kind: governance.deployment_guide
layer: platform
status: draft
refs:
- rel: depends_on
  to: SR-SPEC
- rel: depends_on
  to: SR-CONTRACT
---

# SR-DEPLOYMENT: Deployment Guide

**Purpose:** Provide step-by-step instructions for deploying SOLVER-Ralph in development and production environments.

**Normative Status:** Informative (non-binding)

---

## 1. Prerequisites

### 1.1 Required Software

| Software | Minimum Version | Purpose |
|----------|-----------------|---------|
| Docker | 24.0+ | Container runtime |
| Docker Compose | 2.20+ | Multi-container orchestration |
| Rust | 1.75+ | Building the API and domain crates |
| Node.js | 20.0+ | Building the UI (optional) |
| PostgreSQL Client | 16+ | Database management (optional) |

### 1.2 Hardware Requirements

**Development:**
- 4GB RAM minimum (8GB recommended)
- 10GB disk space
- 2 CPU cores

**Production:**
- 16GB RAM minimum
- 50GB SSD storage
- 4+ CPU cores
- Network access to external services (Infisical, if used)

---

## 2. Quick Start (Development)

### 2.1 Clone and Initialize

```bash
# Clone the repository
git clone <repository-url>
cd solver-ralph

# Run the complete initialization
./scripts/init-all.sh
```

The `init-all.sh` script will:
1. Verify Docker is running
2. Check required dependencies
3. Start all Docker services
4. Initialize PostgreSQL schemas
5. Create MinIO buckets
6. Generate development secrets

### 2.2 Verify Initialization

```bash
# Check service status
./deploy/init.sh --check

# Expected output:
# PostgreSQL:  ✓ Running
#   - Event store schema: ✓ Initialized
# MinIO:       ✓ Running
# NATS:        ✓ Running
# Zitadel:     ✓ Running
```

### 2.3 Start the API

```bash
# Copy environment configuration
cp .env.example .env

# Build and run the API
cargo run --bin sr-api
```

The API will be available at `http://localhost:3000`.

---

## 3. Docker Compose Services

### 3.1 Service Overview

| Service | Container | Port | Purpose |
|---------|-----------|------|---------|
| PostgreSQL | sr-postgres | 5432 | Event store and projections |
| MinIO | sr-minio | 9000/9001 | Evidence and artifact storage |
| NATS | sr-nats | 4222/8222 | Message bus and orchestration |
| Zitadel | sr-zitadel | 8080 | OIDC identity provider |
| Infisical | sr-infisical | 8080 | Secrets management (optional) |

### 3.2 Starting Services

```bash
# Start infrastructure only (recommended for development)
cd deploy
docker compose up -d

# Start full stack including API and UI
docker compose --profile full up -d

# Stop all services
docker compose down

# Stop and remove volumes (clean slate)
docker compose down -v
```

### 3.3 Service Configuration

Services are configured via environment variables. See `deploy/.env.secrets` (generated by init.sh) or `.env.example` for available options.

---

## 4. Database Initialization

### 4.1 Schemas

SOLVER-Ralph uses three PostgreSQL schemas:

| Schema | Purpose |
|--------|---------|
| `es` | Event store (append-only events, outbox) |
| `proj` | Projections (read models) |
| `graph` | Dependency graph (nodes, edges) |

### 4.2 Migrations

Migrations are located in `migrations/` and applied by `deploy/init.sh`:

```
001_event_store.sql    - Core event store tables
002_projections.sql    - Read model projections
003_graph.sql          - Dependency graph tables
004_evidence.sql       - Evidence association
005_intakes.sql        - Intake portal tables
006_work_surfaces.sql  - Work surface definitions
007_loops_work_surface_id.sql - Loop work surface FK
008_oracle_suite_registry.sql - Oracle suite metadata
009_loop_stop_triggers.sql - Loop pause mechanisms
```

### 4.3 Manual Migration

```bash
# Apply migrations manually
export PGPASSWORD=postgres
psql -h localhost -U postgres -d solver_ralph -f migrations/001_event_store.sql
```

---

## 5. MinIO Configuration

### 5.1 Buckets

Three buckets are created by `deploy/init.sh`:

| Bucket | Purpose |
|--------|---------|
| `evidence` | Evidence bundles from oracle runs |
| `candidates` | Candidate artifacts |
| `artifacts` | Attachments and documents |

### 5.2 Access

- **Console:** http://localhost:9001
- **API:** http://localhost:9000
- **Credentials:** minioadmin / minioadmin (development)

### 5.3 Production Configuration

For production, configure:
- Strong access credentials
- TLS/SSL encryption
- Bucket versioning for immutability
- Lifecycle policies for retention

---

## 6. OIDC Configuration (Zitadel)

### 6.1 Initial Setup

1. Access Zitadel Console: http://localhost:8080
2. Login: admin / Admin123!
3. Create a new project: "SOLVER-Ralph"

### 6.2 Applications

Create two applications:

**solver-ralph-ui (Web/SPA):**
- Grant Type: Authorization Code with PKCE
- Redirect URIs: http://localhost:5173/callback
- Post-Logout URIs: http://localhost:5173

**solver-ralph-api (API/Service):**
- Grant Type: Client Credentials
- Copy Client ID and Secret to `.env`

### 6.3 Roles

Create the following roles:
- `sr:admin` - Full administrative access
- `sr:operator` - Operations and monitoring
- `sr:user` - Basic user access

See `deploy/zitadel-config.json` for reference configuration.

---

## 7. Secrets Management (D-16)

### 7.1 Development Mode

For development, use the generated `.env.secrets` file:

```bash
source deploy/.env.secrets
```

### 7.2 Production Mode (Infisical)

For production, use Infisical for secrets management:

1. Create Infisical workspace: "solver-ralph"
2. Configure environment: dev, staging, prod
3. Add secrets per `deploy/infisical-template.json`
4. Set environment variables:

```bash
export INFISICAL_TOKEN=<service-token>
export INFISICAL_WORKSPACE_ID=<workspace-id>
export INFISICAL_ENVIRONMENT=prod
```

### 7.3 Envelope Key Management

For restricted evidence (D-16), an envelope encryption key (KEK) is required:

```bash
# Generate a production KEK (32 bytes for AES-256-GCM)
openssl rand -base64 32

# Store in Infisical at: solver-ralph/kek/solver-ralph-kek
```

---

## 8. Environment Variables

### 8.1 Required

| Variable | Description | Default |
|----------|-------------|---------|
| `SR_DATABASE_URL` | PostgreSQL connection string | - |
| `MINIO_ENDPOINT` | MinIO API endpoint | http://localhost:9000 |
| `MINIO_ACCESS_KEY` | MinIO access key | minioadmin |
| `MINIO_SECRET_KEY` | MinIO secret key | minioadmin |
| `SR_NATS_URL` | NATS connection URL | nats://localhost:4222 |
| `SR_OIDC_ISSUER` | OIDC issuer URL | http://localhost:8080 |

### 8.2 Optional

| Variable | Description | Default |
|----------|-------------|---------|
| `SR_HOST` | API bind host | 0.0.0.0 |
| `SR_PORT` | API bind port | 3000 |
| `SR_LOG_LEVEL` | Log level (trace, debug, info, warn, error) | debug |
| `SR_LOG_FORMAT` | Log format (pretty, json) | pretty |
| `SR_ENABLE_SEMANTIC_WORKER` | Enable semantic worker | false |

See `.env.example` for complete list.

---

## 9. Health Checks

### 9.1 Endpoints

| Endpoint | Purpose | Authentication |
|----------|---------|----------------|
| `/health` | Basic health check | None |
| `/ready` | Dependency readiness (V11-3) | None |
| `/api/v1/metrics` | Metrics and statistics | None |

### 9.2 Readiness Check

The `/ready` endpoint checks:
- PostgreSQL connectivity
- MinIO connectivity
- NATS connectivity

Returns HTTP 200 if all healthy, HTTP 503 if any unhealthy.

---

## 10. Troubleshooting

### 10.1 PostgreSQL Connection Issues

```bash
# Check container status
docker ps | grep sr-postgres

# Check logs
docker logs sr-postgres

# Test connection
docker exec sr-postgres pg_isready -U postgres
```

### 10.2 MinIO Connection Issues

```bash
# Check health
curl http://localhost:9000/minio/health/live

# Check logs
docker logs sr-minio
```

### 10.3 NATS Connection Issues

```bash
# Check health
curl http://localhost:8222/healthz

# Check logs
docker logs sr-nats
```

### 10.4 Zitadel Issues

```bash
# Check health
curl http://localhost:8080/debug/healthz

# Check logs
docker logs sr-zitadel
```

---

## 11. Production Checklist

Before deploying to production:

- [ ] Configure strong database credentials
- [ ] Configure TLS/SSL for all services
- [ ] Set up Infisical for secrets management
- [ ] Generate production envelope key (KEK)
- [ ] Configure Zitadel with real OIDC settings
- [ ] Set up monitoring and alerting
- [ ] Configure backup strategy for PostgreSQL
- [ ] Review and apply security hardening
- [ ] Set appropriate resource limits
- [ ] Document runbooks for operations team
