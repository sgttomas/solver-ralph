# SOLVER-Ralph Continuous Integration
#
# D-03: Continuous integration baseline (build/test/lint)
# Per SR-PLAN acceptance criteria:
# - CI runs automatically on main and on PR branches
# - CI produces machine-readable summary (pass/fail, durations, artifact hashes)
# - CI failures are surfaced deterministically (no hidden steps)

name: CI

on:
  push:
    branches: [main, solver-ralph-*]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Rust build and test job
  rust:
    name: Rust Build & Test
    runs-on: ubuntu-latest
    outputs:
      build_hash: ${{ steps.hash.outputs.build_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Build workspace
        run: cargo build --workspace --all-targets

      - name: Run tests
        run: cargo test --workspace --all-targets

      - name: Compute build artifacts hash
        id: hash
        run: |
          BUILD_HASH=$(find target/debug -name "*.rlib" -o -name "sr-*" -type f 2>/dev/null | sort | xargs sha256sum 2>/dev/null | sha256sum | cut -d' ' -f1 || echo "no-artifacts")
          echo "build_hash=$BUILD_HASH" >> $GITHUB_OUTPUT
          echo "Build artifacts hash: $BUILD_HASH"

  # UI build and lint job
  ui:
    name: UI Build & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ui
    outputs:
      build_hash: ${{ steps.hash.outputs.build_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci || npm install

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Compute build artifacts hash
        id: hash
        run: |
          BUILD_HASH=$(find dist -type f 2>/dev/null | sort | xargs sha256sum 2>/dev/null | sha256sum | cut -d' ' -f1 || echo "no-artifacts")
          echo "build_hash=$BUILD_HASH" >> $GITHUB_OUTPUT
          echo "Build artifacts hash: $BUILD_HASH"

  # Summary job that produces machine-readable output
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [rust, ui]
    if: always()
    steps:
      - name: Generate CI summary
        run: |
          cat << EOF > ci-summary.json
          {
            "workflow_run_id": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "jobs": {
              "rust": {
                "status": "${{ needs.rust.result }}",
                "build_hash": "${{ needs.rust.outputs.build_hash }}"
              },
              "ui": {
                "status": "${{ needs.ui.result }}",
                "build_hash": "${{ needs.ui.outputs.build_hash }}"
              }
            },
            "overall_status": "${{ (needs.rust.result == 'success' && needs.ui.result == 'success') && 'success' || 'failure' }}"
          }
          EOF
          cat ci-summary.json
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Build Hash |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust | ${{ needs.rust.result }} | \`${{ needs.rust.outputs.build_hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| UI | ${{ needs.ui.result }} | \`${{ needs.ui.outputs.build_hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload CI summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: ci-summary.json
          retention-days: 90

      - name: Fail if any job failed
        if: needs.rust.result != 'success' || needs.ui.result != 'success'
        run: |
          echo "CI failed: Rust=${{ needs.rust.result }}, UI=${{ needs.ui.result }}"
          exit 1
